<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Dashboard Ares-PaaS</title>
    <link href="../css/bootstrap.css" rel="stylesheet" type="text/css" />
    <link href="../css/main.css" rel="stylesheet" type="text/css" />  
  </head>
  <body>
    <div class="navbar navbar-inverse navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="">Ares-PaaS</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right cl-effect-13">
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/profile">Compte</a></li>
            <li><a href="/logout">Logout</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container pt">
      <div class="row mt">
        <div class="col-lg-6 col-lg-offset-2">
          <div class="text-centered">
              <h3>Enregistrer application</h3>
              <hr>
                <form id="app_form" action="/create" method="post">
                  <div class="form-group">
                    <label>Nom de l'application</label>
                      <input id="app" type="text" class="form-control" name="name" data-container="body" data-toggle="popover" data-placename="right" /><br>
                  </div>
                  <div class="form-group">
                  <label>Utilisateur</label>
                  <input type="text" class="form-control" name="user" value="<%= user.local.username%>" data-container="body" data-toggle="popover" data-placename="right" data-content="Ne pas modifier ce champ"/><br>
                  </div>
                  <button id="app_submit" type="submit" class="btn btn-info" disabled="true">Enregistrer</button>
                </form>
                <br>
                <h3>Créer base de données</h3>
                <hr>
                <form id="db_form" action="/createdb" method="post">
                  <div class="form-group">
                    <label>Nom de la base de données</label>
                    <input id="dbname" class="form-control" type="text" name="name" data-container="body" data-toggle="popover" data-placename="right" data-content="ATTENTION : Votre base de données et votre application doivent avoir le même nom"/><br>
                  </div>
                  <div class="form-group">
                    <label>Type</label>
                    <select id="dbtype" class="form-control" name="type">
                      <option value="postgresql">PGSQL</option>
                      <option value="mysql">MySQL</option>
                      <option value="redis">Redis</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Utilisateur</label>
                    <input type="text" class="form-control" name="user" value="<%= user.local.username%>" data-container="body" data-toggle="popover" data-placename="right" data-content="Ne pas modifier ce champ"/><br>
                  </div>
                  <div class="form-group">
                    <input id="createdb" class="btn btn-info" type="submit" value="Créer base de données" onclick="dbCreate()"><br>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <script src="../socket.io/socket.io.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
          var app_name_field = document.getElementById('app');
          var app_default_message = "Après avoir enregistré votre application, faites un commit de votre travail et ajoutez le remote du PaaS avec : git remote add dokku@ares-paas.eu:nomdevotreapp puis faites un git push ares master pour déployer votre application ";
          //document.addEventListener('DOMContentLoaded', function(){
          //  app_name_field.setAttribute('data-content', app_default_message);
          //});

          var socket = io.connect('/');

          function testname(mystr){
            if(!mystr.match(/^[a-zA-Z0-9]+$/)){
              console.log("Error");
              return false;
              }
            return true;
          }

          function teststring(mystr){
            if(mystr.match(/[;|""|'']/)){
              console.log("Error");
              return false;
            }
            return true;
          }

          function dbCreate(){
            var dbName = document.getElementById('dbname').value;
            var dbType = document.getElementById('dbtype').value;
	    console.log(dbType + dbName);
            if(teststring(dbName)){
              socket.emit('dbCreate', {name: dbName, type: dbType});
              window.setTimeout('location.reload()', 1000);
            }
          }
          app_name_field.addEventListener("keyup", app_is_valid)

          function check_app_exists(app_name, callback){
            $.getJSON('/api/app_name_exists/' + encodeURIComponent(app_name), callback);
          }

          function app_is_valid() {
            var app_name = app_name_field.value;

            if(!app_name){
              $('#app').popover('hide');
              app_name_field.setAttribute('data-content', app_default_message);
              $('#app').popover('show');
              document.getElementById('app_submit').disabled = true;
            }
            else if( ! testname(app_name)){
              $('#app').popover('hide');
              app_name_field.setAttribute('data-content', "Le nom de l'application doit être alphanumérique");
              $('#app').popover('show');
              document.getElementById('app_submit').disabled = true;
            }
            else {
              //console.log("Le nom est valide. Voyons si une application de ce nom existe déjà...")
              check_app_exists(app_name, function(app_exists){
                if(app_exists) {
                  $('#app').popover('hide');
                  app_name_field.setAttribute('data-content', "Ce nom existe déjà");
                  $('#app').popover('show');
                }
                else {
                  $('#app').popover('hide');
                  app_name_field.setAttribute('data-content', "Ce nom est valide");
                  $('#app').popover('show');
                }

                document.getElementById('app_submit').disabled = app_exists;
              });
            }
          }

          $('#app').popover({trigger: 'hover', content: app_default_message});
          $('#dbname').popover();
        </script>
    </body>
</html>
